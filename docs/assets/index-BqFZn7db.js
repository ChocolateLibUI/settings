var L=(s,e,t)=>{if(!e.has(s))throw TypeError("Cannot "+t)};var o=(s,e,t)=>(L(s,e,"read from private field"),t?t.call(s):e.get(s)),w=(s,e,t)=>{if(e.has(s))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(s):e.set(s,t)},d=(s,e,t,n)=>(L(s,e,"write to private field"),n?n.call(s,t):e.set(s,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const u of r)if(u.type==="childList")for(const i of u.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const u={};return r.integrity&&(u.integrity=r.integrity),r.referrerPolicy&&(u.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?u.credentials="include":r.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function n(r){if(r.ep)return;r.ep=!0;const u=t(r);fetch(r.href,u)}})();class y{constructor(e){this.value=e}get ok(){return!0}get err(){return!1}expect(){return this.value}expectErr(e){throw new Error(e)}get unwrap(){return this.value}unwrapOr(){return this.value}andThen(e){return e(this.value)}orElse(){return this}map(e){return new y(e(this.value))}mapErr(){return this}get toOptional(){return new E(this.value)}safeUnwrap(){return this.value}}var p;const P=class P{constructor(e){w(this,p,void 0);d(this,p,new Error().stack),this.error=e}get valid(){return!1}get ok(){return!1}get err(){return!0}expect(e){throw new Error(e+`
Original `+o(this,p)+`
Expect Error`)}expectErr(){return this.error}get unwrap(){throw new Error(`Tried to unwrap Error
Original `+o(this,p)+`
Unwrap Error`)}unwrapOr(e){return e}andThen(){return this}orElse(e){return e(this.error)}map(){return this}mapErr(e){return new P(e(this.error))}get toOptional(){return new I}get stack(){return o(this,p)}};p=new WeakMap;let N=P;class E{constructor(e){this.value=e}get valid(){return!0}get some(){return!0}get none(){return!1}expect(){return this.value}get unwrap(){return this.value}unwrapOr(){return this.value}andThen(e){return e(this.value)}orElse(){return this}map(e){return new E(e(this.value))}toResult(){return new y(this.value)}}class I{get valid(){return!1}get some(){return!1}get none(){return!0}expect(e){throw new Error(e)}get unwrap(){throw new Error("Tried to unwrap None")}unwrapOr(e){return e}andThen(){return this}orElse(e){return e()}map(){return this}toResult(e){return new N(e)}}function S(s){return new y(s)}function k(s){return new E(s)}function J(){return new I}class V{constructor(){this.subscribers=[]}subscribe(e,t){return this.subscribers.includes(e)?(console.warn("Function already registered as subscriber"),e):(this.subscribers.push(e),t&&this.then(n=>{e(n)}),e)}unsubscribe(e){const t=this.subscribers.indexOf(e);return t!=-1?this.subscribers.splice(t,1):console.warn("Subscriber not found with state",this,e),e}related(){return J()}inUse(){return!!this.subscribers.length}hasSubscriber(e){return this.subscribers.includes(e)}updateSubscribers(e){for(let t=0,n=this.subscribers.length;t<n;t++)try{this.subscribers[t](e)}catch(r){console.warn("Failed while calling subscribers ",r,this,this.subscribers[t])}}}var l,b,c,f;class C extends V{constructor(t,n,r,u){super();w(this,l,void 0);w(this,b,void 0);w(this,c,void 0);w(this,f,void 0);if(n&&d(this,b,n===!0?i=>o(this,c)?o(this,c).limit(i).map(a=>S(a)):k(S(i)):n),r&&d(this,c,r),u&&d(this,f,u),t instanceof Promise)this.then=t.then.bind(t),t.then(i=>{d(this,l,i),delete this.then,delete this.write}),this.write=i=>{t.then(()=>{delete this.write,this.write(i)})};else if(typeof t=="function"){let i=new Promise(a=>{this.then=g=>{let h=t();return this.then=h.then.bind(h),h.then(m=>{d(this,l,m),delete this.then,delete this.write,a()}),h.then(g)}});this.write=a=>{i.then(()=>{delete this.write,this.write(a)})}}else d(this,l,t)}async then(t){return t(o(this,l))}related(){return o(this,f)?o(this,f).call(this):J()}write(t){o(this,b)&&o(this,l).ok&&o(this,l).value!==t&&o(this,b).call(this,t).map(this.set.bind(this))}check(t){return o(this,c)?o(this,c).check(t):void 0}limit(t){return o(this,c)?o(this,c).limit(t):k(t)}set(t){d(this,l,t),this.updateSubscribers(t)}}l=new WeakMap,b=new WeakMap,c=new WeakMap,f=new WeakMap;let D=localStorage["settings/packageVersions"],v={};try{v=D?JSON.parse(D):{}}catch{}let O,G=(s,e,t,n)=>{let r;return v[s]!==e&&(r=v[s],v[s]=e,O&&clearTimeout(O),O=setTimeout(()=>{localStorage["settings/packageVersions"]=JSON.stringify(v)},1e3)),new x(s,t,n,r||void 0)};class x{constructor(e,t,n,r){this.settings={},this.subGroups={},this.versionChanged=r,this.pathID=e,this.name=t,this.description=n}makeSubGroup(e,t,n){if(e in this.subGroups){console.warn("Sub group already registered "+e);return}return this.subGroups[e]=new x(this.pathID+"/"+e,t,n,this.versionChanged)}addSetting(e,t,n,r,u,i){if(e in this.settings)throw new Error("Settings already registered "+e);let a=localStorage[this.pathID+"/"+e],g=this.settings[e]=new C(async()=>{if(a)try{if(this.versionChanged&&i){let m=i(JSON.parse(a),this.versionChanged);return localStorage[this.pathID+"/"+e]=JSON.stringify(m),S(m)}return S(JSON.parse(a))}catch{}let h;return t instanceof Promise?h=await t:typeof t=="function"?h=await t():h=t,localStorage[this.pathID+"/"+e]=JSON.stringify(h),S(h)},n,r,u);return g.subscribe(h=>{localStorage[this.pathID+"/"+e]=JSON.stringify(h.unwrap)}),g}}const B="@chocolatelibui/settings",F="0.1.9";let T=G(B,F,"Test Settings","Description of test settings");(async()=>{let s=new C(new Promise(a=>setTimeout(a,500,1)));s.write(2),console.log(await s);let e=T.addSetting("TestBool",!1,!0),t=document.createElement("input");t.type="checkbox",document.body.appendChild(t),t.checked=(await e).unwrap,t.addEventListener("change",a=>{e.write(t.checked)});let n=T.addSetting("TestNumber",99,!0,void 0,void 0,(a,g)=>{switch(g){case"0.1.1":return 100;case"0.1.5":return 50;default:return 10}}),r=document.createElement("input");r.type="number",document.body.appendChild(r),r.value=String((await n).unwrap),r.addEventListener("change",async a=>{n.write(Number(r.value)),r.value=String((await n).unwrap)});let u=T.addSetting("TestString",new Promise(a=>{setTimeout(()=>{a("yo")},5e3)}),!0),i=document.createElement("input");document.body.appendChild(i),i.value=(await u).unwrap,i.addEventListener("change",async a=>{u.write(i.value),i.value=(await u).unwrap})})();
