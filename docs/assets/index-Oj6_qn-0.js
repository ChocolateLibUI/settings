var D=(s,e,t)=>{if(!e.has(s))throw TypeError("Cannot "+t)};var a=(s,e,t)=>(D(s,e,"read from private field"),t?t.call(s):e.get(s)),b=(s,e,t)=>{if(e.has(s))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(s):e.set(s,t)},c=(s,e,t,n)=>(D(s,e,"write to private field"),n?n.call(s,t):e.set(s,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const u of i.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();class E{constructor(e){this.value=e}get ok(){return!0}get err(){return!1}expect(){return this.value}expectErr(e){throw new Error(e)}get unwrap(){return this.value}unwrapOr(){return this.value}andThen(e){return e(this.value)}orElse(){return this}map(e){return new E(e(this.value))}mapErr(){return this}get toOptional(){return new O(this.value)}safeUnwrap(){return this.value}}var g;const k=class k{constructor(e){b(this,g,void 0);c(this,g,new Error().stack),this.error=e}get valid(){return!1}get ok(){return!1}get err(){return!0}expect(e){throw new Error(e+`
Original `+a(this,g)+`
Expect Error`)}expectErr(){return this.error}get unwrap(){throw new Error(`Tried to unwrap Error
Original `+a(this,g)+`
Unwrap Error`)}unwrapOr(e){return e}andThen(){return this}orElse(e){return e(this.error)}map(){return this}mapErr(e){return new k(e(this.error))}get toOptional(){return new C}get stack(){return a(this,g)}};g=new WeakMap;let P=k;class O{constructor(e){this.value=e}get valid(){return!0}get some(){return!0}get none(){return!1}expect(){return this.value}get unwrap(){return this.value}unwrapOr(){return this.value}andThen(e){return e(this.value)}orElse(){return this}map(e){return new O(e(this.value))}toResult(){return new E(this.value)}}class C{get valid(){return!1}get some(){return!1}get none(){return!0}expect(e){throw new Error(e)}get unwrap(){throw new Error("Tried to unwrap None")}unwrapOr(e){return e}andThen(){return this}orElse(e){return e()}map(){return this}toResult(e){return new P(e)}}function S(s){return new E(s)}function I(s){return new O(s)}function V(){return new C}class B{constructor(){this.subscribers=[]}subscribe(e,t){return this.subscribers.includes(e)?(console.warn("Function already registered as subscriber"),e):(this.subscribers.push(e),t&&this.then(n=>{e(n)}),e)}unsubscribe(e){const t=this.subscribers.indexOf(e);return t!=-1?this.subscribers.splice(t,1):console.warn("Subscriber not found with state",this,e),e}related(){return V()}inUse(){return!!this.subscribers.length}hasSubscriber(e){return this.subscribers.includes(e)}updateSubscribers(e){for(let t=0,n=this.subscribers.length;t<n;t++)try{this.subscribers[t](e)}catch(r){console.warn("Failed while calling subscribers ",r,this,this.subscribers[t])}}}var h,f,l,m;class G extends B{constructor(t,n,r,i){super();b(this,h,void 0);b(this,f,void 0);b(this,l,void 0);b(this,m,void 0);if(n&&c(this,f,n===!0?u=>a(this,l)?a(this,l).limit(u).map(o=>S(o)):I(S(u)):n),r&&c(this,l,r),i&&c(this,m,i),t instanceof Promise)this.then=t.then.bind(t),t.then(u=>{c(this,h,u),delete this.then,delete this.write}),this.write=u=>{t.then(()=>{delete this.write,this.write(u)})};else if(typeof t=="function"){let u=new Promise(o=>{this.then=w=>{let d=t();return this.then=d.then.bind(d),d.then(y=>{c(this,h,y),delete this.then,delete this.write,o()}),d.then(w)}});this.write=o=>{u.then(()=>{delete this.write,this.write(o)})}}else c(this,h,t)}async then(t){return t(a(this,h))}related(){return a(this,m)?a(this,m).call(this):V()}write(t){a(this,f)&&a(this,h).ok&&a(this,h).value!==t&&a(this,f).call(this,t).map(this.set.bind(this))}check(t){return a(this,l)?a(this,l).check(t):void 0}limit(t){return a(this,l)?a(this,l).limit(t):I(t)}set(t){c(this,h,t),this.updateSubscribers(t)}}h=new WeakMap,f=new WeakMap,l=new WeakMap,m=new WeakMap;let J=localStorage["settings/packageVersions"],v={};try{v=J?JSON.parse(J):{}}catch{}let N,F=(s,e,t,n)=>{let r;return v[s]!==e&&(r=v[s],v[s]=e,N&&clearTimeout(N),N=setTimeout(()=>{localStorage["settings/packageVersions"]=JSON.stringify(v)},1e3)),new L(s,t,n,r||void 0)};class U extends G{constructor(e,t,n,r,i,u){super(e,r,i,u),this.name=t,this.description=n}}class L{constructor(e,t,n,r){this.settings={},this.subGroups={},this.versionChanged=r,this.pathID=e,this.name=t,this.description=n}makeSubGroup(e,t,n){if(e in this.subGroups){console.warn("Sub group already registered "+e);return}return this.subGroups[e]=new L(this.pathID+"/"+e,t,n,this.versionChanged)}addSetting(e,t,n,r,i,u,o,w){if(e in this.settings)throw new Error("Settings already registered "+e);let d=localStorage[this.pathID+"/"+e],y=this.settings[e]=new U(async()=>{if(d)try{if(this.versionChanged&&w){let T=w(JSON.parse(d),this.versionChanged);return localStorage[this.pathID+"/"+e]=JSON.stringify(T),S(T)}return S(JSON.parse(d))}catch{}let p;return t instanceof Promise?p=await t:typeof t=="function"?p=await t():p=t,localStorage[this.pathID+"/"+e]=JSON.stringify(p),S(p)},n,r,i,u,o);return y.subscribe(p=>{localStorage[this.pathID+"/"+e]=JSON.stringify(p.unwrap)}),y}}const R="@chocolatelibui/settings",q="0.1.10";let x=F(R,q,"Test Settings","Description of test settings");(async()=>{let s=new G(new Promise(o=>setTimeout(o,500,1)));s.write(2),console.log(await s);let e=x.addSetting("TestBool",!1,!0),t=document.createElement("input");t.type="checkbox",document.body.appendChild(t),t.checked=(await e).unwrap,t.addEventListener("change",o=>{e.write(t.checked)});let n=x.addSetting("TestNumber",99,!0,void 0,void 0,(o,w)=>{switch(w){case"0.1.1":return 100;case"0.1.5":return 50;default:return 10}}),r=document.createElement("input");r.type="number",document.body.appendChild(r),r.value=String((await n).unwrap),r.addEventListener("change",async o=>{n.write(Number(r.value)),r.value=String((await n).unwrap)});let i=x.addSetting("TestString",new Promise(o=>{setTimeout(()=>{o("yo")},5e3)}),!0),u=document.createElement("input");document.body.appendChild(u),u.value=(await i).unwrap,u.addEventListener("change",async o=>{i.write(u.value),u.value=(await i).unwrap})})();
